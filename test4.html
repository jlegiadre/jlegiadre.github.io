<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Expandable Flex Grid — 75/25 Split (JSON + SC Carousel)</title>

<style>
  :root{
    --gap: 20px;
    --overlay-dim: rgba(0,0,0,.10);
    --shadow: 0 8px 24px rgba(0,0,0,.18);

    /* Tiles (exit stagger) */
    --stagger-shift: 175px;
    --stagger-dur: .58s;
    --stagger-step: .05s;
    --stagger-ease: ease;

    /* Panels (stage) */
    --stage-delay: calc(var(--stagger-dur) + (var(--stagger-step) * 2)); /* img + title + role */
    --stage-in-dur: .5s;
    --stage-out-dur: .45s;
    --stage-ease: ease;
    --right-gap: .15s;
    --panel-bg: #0f273f;
    --panel-fg: #f3f1f1;
    --stage-shadow: none;

    /* Tile re-entry */
    --tile-in-dur: .35s;
    --tile-in-ease: cubic-bezier(.16,.84,.44,1);
    --tile-base-delay: calc(var(--tile-in-dur) - .15s);
    --tile-entry-offset: 10px;

    /* Interaction */
    --hover-lift: -2px;
    --hover-shadow: var(--shadow);
    --focus-outline: 2px solid #000;
    --focus-offset: 3px;

    /* Buffers (for JS to read if desired) */
    --stage-out-buffer: .02s; /* ~20ms */
  }

  /* Base */
  html, body { height: 100%; background: #f3f1f1; }
  html { box-sizing: border-box; }
  *, *::before, *::after { box-sizing: inherit; }
  body { margin:0; color:#111; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* ===== BOX / GRID ===== */
  .container { width: 100%; }
  .box { position: relative; width: 80%; margin: 40px auto; }

  .box__row { display:flex; flex-wrap:wrap; gap:var(--gap); padding:var(--gap); transition: visibility .001s linear; }
  .box__row.is-hidden { visibility: hidden; }

  .box__row-cell {
    position:relative;
    background: var(--tile-bg, #ffffff);
    overflow:hidden; cursor:pointer;
    transition:
      transform .2s ease,
      box-shadow .25s ease,
      opacity .25s ease,
      background-color var(--stagger-dur) var(--stagger-ease);
    outline:none; flex:1 1 100%;
  }
  .box__row-cell:focus-visible { outline: var(--focus-outline); outline-offset: var(--focus-offset); }
  .box__row-cell:hover { transform: translateY(var(--hover-lift)); box-shadow: var(--hover-shadow); }

  @media (min-width:700px){ .box__row-cell{ flex-basis: calc(50% - var(--gap)/2); } }
  @media (min-width:1024px){ .box__row-cell{ flex-basis: calc(25% - (var(--gap)*3/4)); } }

  .tile__img { display:block; width:100%; height:auto; aspect-ratio:495/350; object-fit:cover; }
  .tile__meta { 
	  background:var(--tile-meta-bg); 
	  padding:12px 14px 14px; 
		text-align: left; 
		padding: 2% 0% 4%; 
	}
	.tile__meta::before { 
		content: ""; 
		display: block; 
		position: relative; 
		top: 0; 
		right: 0; 
		height: 2px; 
		background: #dcb24c; 
		width: 50%;
	}
	
	
  .tile__title {
	font-family: 'Montserrat', sans-serif; 
	font-weight: 600; 
	text-transform: uppercase; 
	letter-spacing: 1; 
	color: #3D729E; 
	font-size: clamp(18px, 3.75vw, 22px); 
	margin-top: 2%; 
  }
  .tile__role  {	  
	text-transform: capitalize; 
	font-family: 'Bitter', serif; 
	font-weight: 400; 
	font-style: italic; 
	color: #0f273f; 
	font-size: clamp(12px, 2.5vw, 14.66px); 
	letter-spacing: 2; 
 }

  /* Hover-dim others */
  .box__row.is-hover .box__row-cell::after { content:""; position:absolute; inset:0; background:var(--overlay-dim); }
  .box__row.is-hover .box__row-cell.is-hovered::after { opacity:0; background:transparent; }

  /* Fade all except source on click */
  .box__row.is-fading .box__row-cell { opacity:0; pointer-events:none; }
  .box__row.is-fading .box__row-cell.is-source { opacity:1; pointer-events:auto; }

  /* ===== Stagger-out on source tile ===== */
  .stagger-out .tile__img,
  .stagger-out .tile__title,
  .stagger-out .tile__role {
    will-change: transform, opacity;
    transition: transform var(--stagger-dur) var(--stagger-ease), opacity var(--stagger-dur) var(--stagger-ease);
  }
  .stagger-out.run .tile__img   { transform: translateX(var(--stagger-shift)); opacity:0; transition-delay:0s; }
  .stagger-out.run .tile__title { transform: translateX(var(--stagger-shift)); opacity:0; transition-delay: var(--stagger-step); }
  .stagger-out.run .tile__role  { transform: translateX(var(--stagger-shift)); opacity:0; transition-delay: calc(var(--stagger-step) * 2); }

  .box__row-cell.stagger-out {
    transition:
      transform .2s ease,
      box-shadow var(--stagger-dur) var(--stagger-ease),
      opacity .25s ease,
      background-color var(--stagger-dur) var(--stagger-ease);
  }
  .box__row-cell.stagger-out:hover { box-shadow: none; transform: none; }
  .box__row-cell.stagger-out.run { box-shadow: none; background-color: transparent; }
  .box__row.is-fading .box__row-cell.is-source:hover { box-shadow: none; transform: none; }

  /* ===== CSS re-entry animation ===== */
  @keyframes tileIn {
    from { opacity: 0; transform: translateY(var(--tile-entry-offset)); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .box__row.is-revealing .box__row-cell {
    will-change: opacity, transform;
    animation: tileIn var(--tile-in-dur) var(--tile-in-ease) both;
    animation-delay: calc(var(--i, 0) * var(--tile-base-delay));
  }

  /* ===== STAGE OVERLAY (side-by-side 75/25) ===== */
  .stage {
    position: absolute;
    top: var(--gap);
    left: var(--gap);
    right: var(--gap);
    display: none;
    z-index: 10;
    grid-template-columns: 3fr 1fr;
    gap: 0;
    align-items: stretch;
    overflow: hidden;
    pointer-events: none;
  }
  .stage.is-open { display: grid; box-shadow: var(--stage-shadow); }

  /* LEFT: SC carousel lives here */
  .stage__left {
    pointer-events: auto;
    background: #000;               /* SC style default */
    aspect-ratio: 495 / 350;
    transform: translateX(-101%);
    position: relative;
    overflow: hidden;
  }

  /* ====== SC CAROUSEL STYLES (ported) ====== */
  .sc { position: relative; width: 100%; height: 100%; }
  .sc__viewport { position: relative; overflow: hidden; touch-action: pan-y; background-color: #fff; height: 100%; }
  .sc__track { display: flex; transition: transform .4s ease; will-change: transform; user-select: none; cursor: grab; height: 100%; transform: translateX(0%); }
  .sc__track.is-dragging { cursor: grabbing; }
  .sc__slide { min-width: 100%; height: 100%; display: grid; place-items: center; }
  .sc__media { display: block; width: 100%; height: 100%; }
  .sc img { -webkit-user-drag: none; user-select: none; max-width: 100%; max-height: 100%; object-fit: contain; width: 100%; }

  .sc__nav {
    position: absolute; top: 0; bottom: 0; width: 48px; border: 0;
    color: #0f273f; font-size: 28px; line-height: 1; cursor: pointer; background: transparent;
  }
  .sc__nav--prev { left: 0; }
  .sc__nav--next { right: 0; }

  .sc__controls { position: absolute; left: 0; bottom: 0; padding: 10px 14px; min-height: 56px; color: #0f273f; display: flex; align-items: center; gap: 10px; justify-content: center; }
  .sc__dots { display: inline-flex; gap: 8px; }
  .sc__dot { width: 8px; height: 8px; border-radius: 999px; border: 0; padding: 0; background: rgba(15,39,63,.45); cursor: pointer; }
  .sc__dot[aria-selected="true"] { background: #0f273f; transform: scale(1.2); }

  .sc__toggle {
    background: transparent; border: 1px solid rgba(15,39,63,1);
    color: #fff; border-radius: 999px; padding: 6px 10px; font-size: 12px; cursor: pointer;
  }
  .sc__toggle::before { content: '❚❚'; margin-right: 6px; font-size: 12px; }
  .sc__toggle[aria-pressed="false"]::before { content: '►'; }

  @media screen and (max-width: 760px) {
    .sc__nav { width: 24px; }
    .sc__controls { padding: 5px 7px; min-height: 42px; position: relative; }
    .sc__dot { background: rgba(0,0,0,.45); }
    .sc__dot[aria-selected="true"] { background: #000; }
    .sc__toggle { border: 1px solid rgba(0,0,0,.35); color: #000; }
    .sc__viewport { background-color: #fff; }
  }

  /* RIGHT PANEL */
  .stage__right {
    pointer-events: auto;
    position: relative;
    background: var(--panel-bg);
    color: var(--panel-fg);
    padding: 18px 18px 24px 18px;
    transform: translateX(101%);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  /* Slide-in/out */
  .stage.is-open .stage__left  { animation: slideInLeft  var(--stage-in-dur) var(--stage-ease) forwards;  animation-delay: var(--stage-delay); }
  .stage.is-open .stage__right { animation: slideInRight var(--stage-in-dur) var(--stage-ease) forwards;  animation-delay: calc(var(--stage-delay) + var(--right-gap)); }
  @keyframes slideInLeft  { from { transform: translateX(-101%); } to { transform: translateX(0); } }
  @keyframes slideInRight { from { transform: translateX(101%);  } to { transform: translateX(0); } }

  .stage.is-closing .stage__left  { animation: slideOutLeft  var(--stage-out-dur) var(--stage-ease) forwards; }
  .stage.is-closing .stage__right { animation: slideOutRight var(--stage-out-dur) var(--stage-ease) forwards; }
  .stage.is-closing .stage__close { opacity: 0; pointer-events:none; transition: opacity .2s ease; }
  @keyframes slideOutLeft  { from { transform: translateX(0); } to { transform: translateX(-101%); } }
  @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(101%); } }

  .panel__title { margin:0 0 8px; font:700 22px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; letter-spacing:.2px; }
  .panel__role  { margin:0 0 10px; font:400 14px/1.45 system-ui; color:#cfd5dd; }
  .panel__desc  { margin:0; font:400 14px/1.6 system-ui; color:#d8dde3; }

  .panel__links { margin: 12px 0 0; display: flex; gap: 10px; flex-wrap: wrap; }
  .panel__link { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius: 999px; background:#2a2d32; color:#f3f1f1; text-decoration:none; font-size:13px; }
  .panel__tags { margin: 12px 0 0; display:flex; flex-wrap:wrap; gap:6px; }
  .panel__tag { font-size:12px; padding:4px 8px; background:#dcb24c; border-radius:999px; color:#0f273f; }

  /* Close button */
  .stage__close {
    position: absolute; top: 10px; right: 10px; width: 36px; height: 36px;
    border: 0; background: transparent; cursor: pointer; padding: 0;
  }
  .stage__close .inner { position: relative; width: 100%; height: 100%; text-align: center; }
  .stage__close .label { display: block; font-size: .8em; line-height: 36px; text-transform: uppercase; color: #fff; transition: all .3s ease-in; opacity: 0; pointer-events: none; }
  .stage__close .inner::before, .stage__close .inner::after {
    content: ''; position: absolute; right: 0; width: 200%; height: 1px; background: #FFC107; transition: all .3s ease-in;
  }
  .stage__close .inner::before { top: 50%;  transform: rotate(45deg); }
  .stage__close .inner::after  { bottom: 50%; transform: rotate(-45deg); }
  .stage__close:hover .label { opacity: 1; }
  .stage__close:hover .inner::before, .stage__close:hover .inner::after { transform: rotate(0); }
  .stage__close:hover .inner::before { top: 0; }
  .stage__close:hover .inner::after  { bottom: 0; }
  .stage__close:focus-visible { outline: 2px solid #fff; outline-offset: 3px; }

  @media (prefers-reduced-motion: reduce) {
    .stagger-out .tile__img, .stagger-out .tile__title, .stagger-out .tile__role { transition: none !important; }
    .stage.is-open .stage__left, .stage.is-open .stage__right, .stage.is-closing .stage__left, .stage.is-closing .stage__right {
      animation: none !important; transform: translateX(0) !important;
    }
    .box__row.is-revealing .box__row-cell { animation: none !important; opacity: 1 !important; transform: none !important; }
    .sc__track { transition: none !important; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="box" id="box">
    <!-- Grid populated from JSON -->
    <div class="box__row" id="grid" role="list" aria-live="polite"></div>

    <!-- Stage overlay -->
    <div class="stage" id="stage" aria-live="polite">
      <section class="stage__left" id="stageLeft" aria-hidden="true"></section>
      <aside class="stage__right" id="stageRight" role="dialog" aria-modal="true" aria-label="Project details">
        <h2 class="panel__title" id="panelTitle">Title</h2>
        <p class="panel__role" id="panelRole"></p>
        <p class="panel__desc" id="panelDesc"></p>
        <div class="panel__links" id="panelLinks" hidden></div>
        <div class="panel__tags" id="panelTags" hidden></div>
      </aside>
    </div>
  </div>
</div>

<script>
(function(){
  var DATA_URL = '/assets/portfolio.json'; // your JSON path

  var grid        = document.getElementById('grid');
  var stage       = document.getElementById('stage');
  var stageLeft   = document.getElementById('stageLeft');
  var stageRight  = document.getElementById('stageRight');
  var panelTitle  = document.getElementById('panelTitle');
  var panelRole   = document.getElementById('panelRole');
  var panelDesc   = document.getElementById('panelDesc');
  var panelLinks  = document.getElementById('panelLinks');
  var panelTags   = document.getElementById('panelTags');

  var tiles = [];
  var items = [];
  var lastSourceTile = null;
  var animating = false;

  function cssMs(name, fallback){
    var raw = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if(!raw) return fallback;
    if(raw.endsWith('ms')) return parseFloat(raw);
    if(raw.endsWith('s'))  return parseFloat(raw)*1000;
    var n = parseFloat(raw);
    return isNaN(n) ? fallback : n;
  }
  function readTimings(){
    return {
      staggerDur:   cssMs('--stagger-dur',  580),
      staggerStep:  cssMs('--stagger-step',  50),
      stageIn:      cssMs('--stage-in-dur',  500),
      stageOut:     cssMs('--stage-out-dur', 450),
      rightGap:     cssMs('--right-gap',     150),
      tileInDur:    cssMs('--tile-in-dur',   350)
    };
  }

  // Load JSON -> render tiles
  async function loadData(){
    try {
      const res = await fetch(DATA_URL, { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      items = await res.json();
    } catch (e) {
      console.warn('Could not fetch /assets/portfolio.json', e);
      items = [];
    }
    renderTiles(items);
  }

  function renderTiles(list){
    grid.innerHTML = '';
    list.forEach(function(item, i){
      var art = document.createElement('article');
      art.className = 'box__row-cell';
      art.setAttribute('role','listitem');
      art.setAttribute('tabindex','0');
      art.dataset.index = i;
      art.style.setProperty('--i', i);

      var img = document.createElement('img');
      img.className = 'tile__img';
      img.src = item.cover || (item.gallery && item.gallery[0]) || '';
      img.alt = (item.title || 'Project') + ' preview';
      img.loading = 'lazy';
      img.decoding = 'async';

      var meta = document.createElement('div'); meta.className = 'tile__meta';
      var h3 = document.createElement('h3'); h3.className = 'tile__title'; h3.textContent = item.title || 'Untitled';
      var p = document.createElement('p');  p.className = 'tile__role';   p.textContent = item.role || '';

      meta.appendChild(h3); meta.appendChild(p);
      art.appendChild(img); art.appendChild(meta);
      grid.appendChild(art);
    });

    tiles = Array.prototype.slice.call(grid.querySelectorAll('.box__row-cell'));
    grid.addEventListener('mouseover', onHoverOver);
    grid.addEventListener('mouseout', onHoverOut);

    tiles.forEach(function(tile){
      tile.addEventListener('click', function(){ openFrom(tile); });
      tile.addEventListener('keydown', function(e){
        var k = e.key || e.code;
        if (k === 'Enter' || k === ' ' || k === 'Spacebar' || e.keyCode === 13 || e.keyCode === 32) {
          e.preventDefault(); openFrom(tile);
        }
      });
    });
  }

  function onHoverOver(e){
    var t = e.target.closest('.box__row-cell');
    if (!t || !grid.contains(t)) return;
    grid.classList.add('is-hover');
    tiles.forEach(function(x){ x.classList.toggle('is-hovered', x===t); });
  }
  function onHoverOut(e){
    if (!grid.contains(e.relatedTarget)) {
      grid.classList.remove('is-hover');
      tiles.forEach(function(x){ x.classList.remove('is-hovered'); });
    }
  }

  function injectCloseButton(){
    if (document.getElementById('stageClose')) return;
    var btn = document.createElement('button');
    btn.className = 'stage__close';
    btn.id = 'stageClose';
    btn.type = 'button';
    btn.setAttribute('aria-label','Close details');
    btn.innerHTML = '<span class="inner"><span class="label">Back</span></span>';
    stageRight.appendChild(btn);

    btn.addEventListener('click', closeStage);
    btn.addEventListener('keydown', function(e){
      var k = e.key || e.code;
      if (k === 'Enter' || k === ' ' || k === 'Spacebar' || e.keyCode === 13 || e.keyCode === 32) {
        e.preventDefault(); closeStage();
      }
    });
    return btn;
  }
  function removeCloseButton(){
    var btn = document.getElementById('stageClose');
    if (btn && btn.parentNode) btn.parentNode.removeChild(btn);
  }

  /* ===== Mount SC Carousel into stageLeft ===== */
  function mountSC(images){
    stageLeft.innerHTML = '';

    var root = document.createElement('div');
    root.className = 'sc';
    root.setAttribute('aria-roledescription','carousel');

    var viewport = document.createElement('div');
    viewport.className = 'sc__viewport';

    var track = document.createElement('div');
    track.className = 'sc__track';

    // Slides
    var arr = (images && images.length) ? images : [''];
    arr.forEach(function(src, i){
      var slide = document.createElement('div');
      slide.className = 'sc__slide';
      slide.setAttribute('aria-roledescription','slide');
      slide.setAttribute('aria-label', (i+1) + ' of ' + arr.length);

      var media = document.createElement('div');
      media.className = 'sc__media';

      if (src) {
        var img = document.createElement('img');
        img.src = src;
        img.alt = ''; // decorative; title appears on right panel
        img.decoding = 'async';
        img.loading = 'eager';
        media.appendChild(img);
      }
      slide.appendChild(media);
      track.appendChild(slide);
    });

    viewport.appendChild(track);

    // Controls
    var btnPrev = document.createElement('button');
    btnPrev.className = 'sc__nav sc__nav--prev';
    btnPrev.type = 'button';
    btnPrev.setAttribute('aria-label','Previous slide');
    btnPrev.textContent = '‹';

    var btnNext = document.createElement('button');
    btnNext.className = 'sc__nav sc__nav--next';
    btnNext.type = 'button';
    btnNext.setAttribute('aria-label','Next slide');
    btnNext.textContent = '›';

    var controls = document.createElement('div');
    controls.className = 'sc__controls';
    controls.setAttribute('aria-live','polite');

    var toggleBtn = document.createElement('button');
    toggleBtn.className = 'sc__toggle';
    toggleBtn.type = 'button';
    toggleBtn.setAttribute('aria-pressed','true');
    toggleBtn.setAttribute('aria-label','Pause autoplay');
    toggleBtn.textContent = 'Pause';

    var dotsWrap = document.createElement('div');
    dotsWrap.className = 'sc__dots';
    dotsWrap.setAttribute('role','tablist');
    dotsWrap.setAttribute('aria-label','Slide selectors');

    controls.appendChild(toggleBtn);
    controls.appendChild(dotsWrap);

    viewport.appendChild(btnPrev);
    viewport.appendChild(btnNext);
    viewport.appendChild(controls);
    root.appendChild(viewport);
    stageLeft.appendChild(root);

    // ----- Behavior (ported) -----
    var slides = Array.prototype.slice.call(track.querySelectorAll('.sc__slide'));
    var dots = [];
    slides.forEach(function(_, i){
      var d = document.createElement('button');
      d.className = 'sc__dot';
      d.type = 'button';
      d.setAttribute('role','tab');
      d.setAttribute('aria-label','Go to slide ' + (i+1));
      d.addEventListener('click', function(){ goTo(i, true); });
      dotsWrap.appendChild(d);
      dots.push(d);
    });

    slides.forEach(function(slide, i){
      slide.id = 'sc-slide-' + (i+1);
      slide.setAttribute('aria-label', (i+1) + ' of ' + slides.length);
    });

    // Config/state
    var autoplayDefault = true;
    var interval = 5000;
    var index = 0;
    var timer = null;
    var playing = autoplayDefault;

    function render(offsetPct){
      var base = -index * 100;
      track.style.transform = 'translateX(' + (base + (offsetPct || 0)) + '%)';
      dots.forEach(function(d, i){ d.setAttribute('aria-selected', i===index ? 'true' : 'false'); });
    }
    function goTo(i, user){
      if (i < 0) i = slides.length - 1;
      if (i >= slides.length) i = 0;
      index = i;
      track.style.transition = 'transform .4s ease';
      render(0);
      if (user && playing) { stop(); start(); }
    }
    function start(){ stop(); timer = setInterval(function(){ goTo(index + 1, false); }, interval); }
    function stop(){ if (timer) { clearInterval(timer); timer = null; } }

    btnPrev.addEventListener('click', function(){ goTo(index - 1, true); });
    btnNext.addEventListener('click', function(){ goTo(index + 1, true); });

    toggleBtn.addEventListener('click', function(){
      playing = !playing;
      toggleBtn.setAttribute('aria-pressed', String(playing));
      toggleBtn.setAttribute('aria-label', playing ? 'Pause autoplay' : 'Play slideshow');
      toggleBtn.textContent = playing ? 'Pause' : 'Play';
      if (playing) start(); else stop();
    });

    // Drag (touch + mouse)
    var dragging = false, startX = 0, lastX = 0, dragged = false;
    var thresholdPx = 40;
    function trackWidth(){ return stageLeft.clientWidth; }

    track.addEventListener('pointerdown', function(e){
      if (e.button !== 0) return;
      dragging = true; dragged = false;
      startX = lastX = e.clientX;
      track.style.transition = 'none';
      track.classList.add('is-dragging');
      if (playing) stop();
    });
    track.addEventListener('pointermove', function(e){
      if (!dragging) return;
      lastX = e.clientX;
      var dx = lastX - startX;
      var pct = (dx / trackWidth()) * 100;
      render(pct);
    }, { passive: true });
    function endDrag(){
      if (!dragging) return;
      dragging = false;
      track.classList.remove('is-dragging');
      var dx = lastX - startX;
      if (Math.abs(dx) > thresholdPx) {
        dragged = true;
        if (dx < 0) goTo(index + 1, true); else goTo(index - 1, true);
      } else {
        track.style.transition = 'transform .2s ease';
        render(0);
      }
      if (playing) start();
      startX = lastX = 0;
    }
    track.addEventListener('pointerup', endDrag);
    track.addEventListener('pointercancel', endDrag);
    track.addEventListener('pointerleave', function(){ if (dragging) endDrag(); });

    // Prevent click-through on links after drag (future-proof)
    track.addEventListener('click', function(e){
      if (dragged && e.target.closest('.sc__slide a')) {
        e.preventDefault(); e.stopPropagation(); dragged = false;
      }
    }, true);

    // init
    toggleBtn.setAttribute('aria-pressed', String(playing));
    toggleBtn.setAttribute('aria-label', playing ? 'Pause autoplay' : 'Play slideshow');
    render(0);
    if (playing) start();
  }

  function hideGridOnly(){
    grid.classList.add('is-hidden');
    grid.classList.remove('is-fading');
  }

  function openFrom(tile){
    if (animating) return;
    animating = true;
    lastSourceTile = tile;

    removeCloseButton();

    var idx = parseInt(tile.dataset.index, 10) || 0;
    var item = items[idx] || {};

    grid.classList.add('is-fading');
    tile.classList.add('is-source','stagger-out');
    tile.offsetHeight;
    tile.classList.add('run');

    var gallery = Array.isArray(item.gallery) && item.gallery.length ? item.gallery : [item.cover || ''];
    mountSC(gallery); // << use SC carousel

    panelTitle.textContent = item.title || 'Project';
    panelRole.textContent  = item.role || '';
    panelDesc.textContent  = item.description || '';

    panelLinks.innerHTML = '';
    var linkCount = 0;
    if (item.links && (item.links.website || item.links.caseStudy)) {
      if (item.links.website)   { panelLinks.appendChild(linkEl('Website', item.links.website)); linkCount++; }
      if (item.links.caseStudy) { panelLinks.appendChild(linkEl('Case Study', item.links.caseStudy)); linkCount++; }
    }
    panelLinks.hidden = linkCount === 0;

    panelTags.innerHTML = '';
    if (Array.isArray(item.tags) && item.tags.length) {
      item.tags.forEach(function(t){
        var span = document.createElement('span');
        span.className = 'panel__tag';
        span.textContent = t;
        panelTags.appendChild(span);
      });
      panelTags.hidden = false;
    } else {
      panelTags.hidden = true;
    }

    stage.classList.add('is-open');

    var prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReduced) {
      requestAnimationFrame(hideGridOnly);
    } else {
      var onLeftStart = function(e){
        if (e.target !== stageLeft) return;
        if (e.animationName && e.animationName !== 'slideInLeft') return;
        stageLeft.removeEventListener('animationstart', onLeftStart);
        hideGridOnly();
      };
      stageLeft.addEventListener('animationstart', onLeftStart);
    }

    var onRightIn = function(e){
      if (e.target !== stageRight) return;
      if (e.animationName && e.animationName !== 'slideInRight') return;
      stageRight.removeEventListener('animationend', onRightIn);

      var btn = injectCloseButton();
      if (btn) btn.focus();

      tiles.forEach(function(t){ t.classList.remove('stagger-out','run','is-source'); });

      animating = false;
    };
    stageRight.addEventListener('animationend', onRightIn);
  }

  function linkEl(label, href){
    var a = document.createElement('a');
    a.className = 'panel__link';
    a.href = href; a.target = '_blank'; a.rel = 'noopener';
    a.textContent = label;
    return a;
  }

  function closeStage(){
    if (animating || !stage.classList.contains('is-open')) return;
    animating = true;

    var prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    stage.classList.add('is-closing');

    var tcfg = readTimings();
    setTimeout(function(){
      stage.classList.remove('is-open','is-closing');
      removeCloseButton();

      grid.classList.remove('is-hidden');

      if (prefersReduced) {
        grid.classList.remove('is-revealing');
        if (lastSourceTile) lastSourceTile.focus();
        animating = false;
        return;
      }

      grid.classList.add('is-revealing');

      var remaining = tiles.length;
      function onAnimEnd(e){
        if (!e || !e.target || !e.target.classList.contains('box__row-cell')) return;
        if (e.animationName !== 'tileIn') return;
        remaining--;
        if (remaining <= 0) {
          grid.removeEventListener('animationend', onAnimEnd, true);
          grid.classList.remove('is-revealing');
          if (lastSourceTile) lastSourceTile.focus();
          animating = false;
        }
      }
      grid.addEventListener('animationend', onAnimEnd, true);
    }, tcfg.stageOut + 20);
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && stage.classList.contains('is-open')) closeStage();
  });

  loadData();
})();
</script>

</body>
</html>
